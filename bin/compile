#!/usr/bin/env bash

indent() {
  sed -u 's/^/       /'
}

echo "-----> Found main.ml"

echo "       Downloading dependencies"
echo "       Downloading dependencies..."

echo "       Running opam install script..."
sh <(curl -sL https://raw.githubusercontent.com/ocaml/opam/master/shell/install.sh) 2>&1 | sed -u 's/^/       /'

echo "       Installing ocamlbuild..."
opam install ocamlbuild 2>&1 | sed -u 's/^/       /'

echo "       Finished downloading dependencies."

set -e
bpdir=$(cd $(dirname $(dirname $0)); pwd)
mkdir -p "$1" "$2"
build=$(cd "$1/" && pwd)
test -z ${build} && exit
cache=$(cd "$2/" && pwd)
test -z ${cache} && exit


ls -la $build 2>&1 | sed -u 's/^/       /'
ls -la $cache 2>&1 | sed -u 's/^/       /'
ls -la $bpdir 2>&1 | sed -u 's/^/       /'
make all -C $build  2>&1 | sed -u 's/^/       /'
